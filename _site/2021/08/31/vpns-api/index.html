<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Idea For A VPN Service | tait.tech</title>
    <link rel="stylesheet" href="/assets/css/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Tait Hoyem">
    <meta name="keywords" content="">
    <meta name="description" content=""><link rel="stylesheet" href="/assets/css/katex.css">
    
  </head>
  <body>
    <div id="wrapper">
      <header>
	<h1>tait.tech</h1>

        <nav>
	
	<a href="/" class="nav-link"  >Home</a>
	
	<a href="/blog/" class="nav-link"  >Blog</a>
	
	<a href="/ideas/" class="nav-link"  >Ideas</a>
	
	<a href="/links/" class="nav-link"  >Links</a>
	
	<a href="https://github.com/TTWNO/" class="nav-link"   target="_blank" rel="noopener noreferrer" >Github</a>
	
</nav>

      </header>
      <main>
        <article>
  <header>
    <h1 class="post-title">Idea For A VPN Service</h1>
    <time datetime="21-08-31" class="post-date">Tuesday, August 31 2021</time>
  </header>
  <hr>

  <p>Recently I’ve been thinking about starting a VPN service.
This service has some interesting requirements that I have never seen a VPN service do before, so I’d like to put down my thoughts as to what might be sensible for a centralized yet encrypted* VPN service.</p>

<p>I would license all the code and scripts under the AGPLv3.
This creates an environment where I could allow my company to use this code, and any other company for that matter. However, no company would be allowed to take it into their own hands and use it without contributing back to the project.</p>

<h2 id="e2ee-vpn">E2EE VPN</h2>

<p>I want this service in many ways to be on par with <a href="https://protonmail.com">ProtonMail</a>:
end-to-end encrypted (E2EE), and with a focus in data security for the user of the service.</p>

<p>Full encryption, so that even me, the writer and the deployer of the service, cannot view any information about the user: this is the utmost security.
The bad news is that this is very hard to do in a convenient way.
I’ve decided for now that the best thing to do is to target the Linux nerd.
Target the user who is familiar with these advanced security practices, then make them available to the general public as the layers on top of the robust security are refined.</p>

<h2 id="why">Why?</h2>

<p>End-to-end encryption is necessary in a country like Canada, where I may be sent a subpoena to provide customer data.
This is the case especially in the <a href="https://en.wikipedia.org/wiki/Five_Eyes">Five Eyes</a> anglophone group of countries, who essentially spy on each others’ citizens for eachother.
In essence, any data in the hand of one government agency in the “Eyes Countries” may be shared between the Five, Nine, and 14 Eyes countries.</p>

<p>I am not against government surveillance <em>in principle</em>.
In theory, the government should be finding bad guys: pedophiles, sex trafficking rings and drug cartels.
In practice, the U.S. government especially, uses its authority to spy on its own citizens who are simply minding their own business. <del>Bulk data collection</del> mass surveillance is not a freedom respecting characteristic of modern western democracies.
I do run the risk of not being able to help much in the case of a genuine warrant against a genuine, evil criminal.
That is the risk of privacy.</p>

<p>That said, let’s see what can be built that can do these 2 things:</p>
<ol>
  <li>Maximize privacy for the user.</li>
  <li>Allow for (optional) monetization, depending on the provider. This is in some contradiction to premise 1.</li>
</ol>

<h2 id="what-we-need">What We Need</h2>

<p>A VPN service needs access to some basic information:</p>
<ol>
  <li>Service discontinue time (the amount of time until the customer must renew).</li>
  <li>Active connections (a number which can not be exceeded by an individual user).</li>
</ol>

<p>The client needs access to some information from the server as well:</p>
<ol>
  <li>A list of VPNs able to be connected to (with filters).</li>
  <li>For every VPN:
    <ol>
      <li>IP Address.</li>
      <li>Maximum bandwidth.</li>
      <li>Number of connected users or connection saturation percentage.</li>
      <li>Supported protocols.</li>
    </ol>
  </li>
</ol>

<p>Can we do this in a end-to-end encrypted fashion?
I’m honestly not sure. But here are my ideas so far as to how <em>some</em> of these functions might work.</p>

<h2 id="how-to-do-it">How To Do It</h2>

<h3 id="usernames">“Usernames”</h3>

<p>There will be one button to create your account: <em>“Generate username”</em>
The username, or unique identifier for a user will be generated for them by a random generator.
I plan to generate a username from a list of <a href="https://en.wikipedia.org/wiki/Base64">Base 64</a> characters; it will be a guaranteed length of 16.
This gives a total of: <code class="language-plaintext highlighter-rouge">79228162514264337593543950336</code> or <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>7.9</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mn>28</mn></msup></mrow><annotation encoding="application/x-tex">7.9 \times 10^{28}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">7</span><span class="mord">.</span><span class="mord">9</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">8</span></span></span></span></span></span></span></span></span></span></span></span> posibilities.
This is sufficient for a username.</p>

<p>The other option is to use a standard “username” field that uses a modern hash function like <a href="https://en.wikipedia.org/wiki/Secure_Hash_Algorithms">SHA512</a> to store it in the database.
This is less secure as it is vulnerable to a brute-force attack of finding users,
but this is also a very easy attack to defend against, i.e. IP banning after 10-ish tries of not finding a username.</p>

<p>A <em>non-unique, universal</em> <a href="https://en.wikipedia.org/wiki/Salt_(cryptography)">salt</a> will also be used on each username before storing it in the database to make it more secure.
This decreases the possibility of an advanced attacker being able to find usernames in a leaked database using <a href="https://en.wikipedia.org/wiki/Rainbow_table">rainbow tables</a>.
That said, the fact that it is a fixed salt makes it much more vulnerable to an attack.
Although it would be known only by the server machine, it would still be somewhat of a vulnerability.
The operator may also store the salt in an encrypted password store of their own in case the server is erased, broken into, etc.
It would be fairly easy, if they have access to the active salt, to migrate to a new salt every few days/months, or perhaps every time a server upgrade/maintenance happens.
This does run the possibility of larger issues if the server is shut down or hangs during a migration and needs to be restarted.
Many users may end up with accounts they cannot access without manual cleanup.</p>

<p>In the end, the <em>application</em> would need a backup of this salt, otherwise login times would become linear to the number of users as the database checks every user’s salt to see if it matches the hash made with the username input.
Note that the <em>database</em> does not store the salt, so finding it will be very hard, even in the case of a leaked database.</p>

<p>So, here’s the overview:
The username will be generated, then stored <em>after</em> being salted and hashed.
The salt will be a fixed or rolling salt across all usernames to avoid linear scaling of searching for a user.
The server will only see the username once, when sending it to the user for them to save for the first time;
there will be no database entry with the original username in it.</p>

<p>This does mean that if the username is lost, the account is lost too. There is no way to recover the account.
Again, this is ok for now, as my target audience is advanced Linux and privacy enthusiasts.</p>

<h3 id="passwords">“Passwords”</h3>

<p>There are a few options for passwords/secret keys.</p>

<p>I think the best is to treat it similarly to the username is above, except it will <em>not</em> be generated for you.
When a new account is generated, you will be taken to a password reset screen where you will set your password to whatever your want, using your own secure system to handle it.
This is ideal for Linux and tech enthusiasts as they generally already have a password management system setup.</p>

<p>This will also be salted, with its own unique salt, then hashed and stored alongside the username.</p>

<h3 id="active-time-remaining">Active Time Remaining</h3>

<p>It is easy and ideal to have a field connected to a user with their expiry date for their account.
When a payment is made, this date will be increased by the number of days, hours and minutes proportional to the payment received.</p>

<p>For example: if a “month” (30 days) costs ten dollars, then a payment of fifteen dollars would add 45 days to an account. So essentially 33 cents per day, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>10</mn><mrow><mn>30</mn><mo>×</mo><mn>24</mn></mrow></mfrac><mo>=</mo><mn>0.0138</mn></mrow><annotation encoding="application/x-tex"> \frac{10}{30 \times 24}=0.0138</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2484389999999999em;vertical-align:-0.403331em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">0</span><span class="mbin mtight">×</span><span class="mord mtight">2</span><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.403331em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">1</span><span class="mord">3</span><span class="mord">8</span></span></span></span> cents per hour, or <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>10</mn><mrow><mn>30</mn><mo>×</mo><mn>24</mn><mo>×</mo><mn>60</mn></mrow></mfrac><mo>=</mo><mn>0.00023</mn><mover accent="true"><mn>148</mn><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\frac{10}{30 \times 24 \times 60}=0.00023\overline{148}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2484389999999999em;vertical-align:-0.403331em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">0</span><span class="mbin mtight">×</span><span class="mord mtight">2</span><span class="mord mtight">4</span><span class="mbin mtight">×</span><span class="mord mtight">6</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.403331em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8444400000000001em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord">2</span><span class="mord">3</span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8444400000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">4</span><span class="mord">8</span></span></span><span style="top:-3.76444em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span> dollars per minute.
This is the second biggest threat to the users’ data privacy, as this, by definition, cannot be encrypted as my server needs access to this data to decide whether a user should be allowed to: view a list of VPN nodes available to them or connect to a VPN.
The best I can think of in this case is:</p>
<ol>
  <li>Use a system similar to the username: use a common salt and hash algorithm to store them in the database.</li>
  <li>Use full-disk and full-database encryption to keep the data secure to outside attackers.</li>
</ol>

<p>This is not a fantastic solution, and still has the threat of a service provider snooping in on the database.
The truth is: a service provider has root access to any machine it hosts.
This necessitates that the <em>physical</em> infrastructure hosting the central database server must by physically owned and operated by the VPN operator and not any third party.
In addition, it means top security root passwords, tamper resistant cases (in the case of a co-hosting or server room environment), sensors to indicate it has been opened or touched.
If you thought this was bad, wait until the next part.</p>

<h3 id="active-connections">Active Connections</h3>

<p>In order to stop a user from simply using the entire bandwidth of all the VPN nodes available to them, there must be a way to know how many active connections the user has.
This is <em>by far</em> the biggest issue in terms of user privacy.
There are a few options here:</p>
<ol>
  <li>Do not have a limit on the number of connections a user may have. This is dangerous from a <a href="https://en.wikipedia.org/wiki/Denial-of-service_attack">DDoS (distributed denial-of-service)</a> perspective.
This also makes the VPN provider vulnerable to be used as a DDoS distribution method by putting all their traffic through the VPN provider, and them not having any logs—the bad guys could use the distributed nature of VPN nodes to attack whoever they see fit.
This is not a viable option.</li>
  <li>Have a list of connected users sent to the central server every 15 to 30 seconds. This is fairly efficient, but more privacy invasive.</li>
  <li>When a user connects, log an explicit “connect” message.
When a user disconnects, send an explicit “disconnect”.
Have the VPN server report an <em>implicit</em> “disconnect” after an amount of time, say 15 minutes, then send an implicit “connect” message once traffic continues. This is all in RAM under temporary storage and is lost upon restart of the server.</li>
</ol>

<p>The best method (used currently by <a href="https://mullvad.net">Mullvad VPN</a> is 3.</p>

<h2 id="panel">Panel</h2>

<p>The admin panel will have some broad info about the nodes:</p>

<ul>
  <li>Active connections</li>
  <li>Server load (held and reported every minute by the nodes themselves. Not sure how to do this yet.)</li>
  <li>Location</li>
  <li>IP Address</li>
  <li>Failed connections in last X amount of time (i.e. invalid credentials)</li>
  <li>Physical server status (i.e. owned by the hoster vs. contracted out to another hosting company in the area)</li>
</ul>

<p>This panel would also have options to stop, start or soft stop the VPN service on each node for maintenance.
A soft stop will stop new connections and remove it from the list of available servers for the end-user. Users will disconnect whenever they feel like it—eventually winding down to zero connections.
This allows maintenance without service disruption.</p>

<p>I’m not sure how to do this securely.
Best I can think of right now is have an admin login, then have the server have a key in each node machine.
This completely compromises the SSH key system though.
Now every node is secured with nothing but a password. Maybe the console will require connecting to a local instance on a machine through an encrypted connection which will require a key.
Even then, that does make every machine vulnerable to one point of failure (the key to connect to the local instance).</p>

<p>Another way to approach this, security-wise is to make a shell script (or locally running flask app) which reads info about the servers from a sqlite database.
Then, it uses the local computer to connect to the servers—assuming the local machine has all the keys necessary to do so.</p>

<p>This fixes one problem and creates another.
It fixes the single point of failure in the cloud. This <em>massively</em> reduces the attack surface to intentionally stealing physical hardware from trusted parties, or software-hacking these same trusted people.
But, if the key is lost by the host… The entire service is kaput. No maintenance may be performed, no checks, bans, addition of servers can be done whatsoever.
This also increases the possibility of sloppy security from trusted parties.
Perhaps a trusted member leaves his laptop unattended for a few minutes and a hacker is able to steal the simple key file. He’s in!!!
This is very unlikely, I must say, but it comes down to: should I trust people or machines more to keep the data secure.
Depending on the person, I might trust them more.</p>

<h2 id="conclusion">Conclusion</h2>

<p>With all of these ideas in mind, I have realized how difficult it really is to make a VPN service.
Boy do they deserve every dollar they get!
If you don’t have a VPN, get one.
Doesn’t really matter which one, unless you’re a nerd—for your average person you can just pick whatever the best deal is at the time and you’re off to the races.</p>

<p>Anyway, I think I’ve rambled on long enough about VPNs and my crazy ideas, so I’m going to leave this one for now.</p>

<p>Happy VPN hacking :D</p>

</article>

      </main>
      <hr>
      <footer>
        This page is mirrored on <a href="https://beta.tait.tech/2021/08/31/vpns-api/">beta.tait.tech</a>.

      </footer>
    </div>
  </body>
</html>
